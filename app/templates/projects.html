<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Your Projects | VECTR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: white; font-family: Inter, sans-serif; color: #0d6efd; }
        .box { border: 2px solid #0d6efd; border-radius: 15px; padding: 25px; margin-top: 20px !important; }
        table { color: black; }
        th { border-bottom: 1px solid #0d6efd !important; }
        td { border-color: #0d6efd !important; }
        .new-project-btn { border: 2px solid #0d6efd; border-radius: 40px; padding: 10px 30px; font-size: 1.2rem; }
    </style>
</head>

<body>

{% include 'navbar.html' %}

<div class="container">

{% if project_data|length == 0 %}

    <div class="text-center" style="margin-top: 80px;">
        <h1 class="fw-bold">Your Projects</h1>
        <p class="text-secondary">Add and manage all your analyses.</p>

        <a href="{{ url_for('main.analysis') }}" class="btn btn-primary new-project-btn mt-3">
            + New Project
        </a>
    </div>

{% else %}

    <h1 class="fw-bold mt-4">Your Projects</h1>
    <p class="text-secondary">Overview of your project analyses.</p>

    <div class="text-center mt-3 mb-4">
        <a href="{{ url_for('main.analysis') }}" class="btn btn-primary new-project-btn">
            + Add New Project
        </a>
    </div>

    <!-- GRAPH -->
    <div class="d-flex justify-content-center mt-4">
        <div class="box" style="width: 600px;">
            <canvas id="projectChart" height="120"></canvas>
        </div>
    </div>

    <hr style="border-color: #0d6efd; margin: 25px 0;">

    <!-- TABLE -->
    <table class="table table-hover">
        <thead>
        <tr>
            <th>Project</th>
            <th>Cost (â‚¬)</th>
            <th>Confidence</th>
            <th>TV</th>
            <th>ROI</th>
            <th>Edit</th>
            <th>Delete</th>
        </tr>
        </thead>
        <tbody>
        {% for p in project_data %}
            <tr>
                <td>{{ p.name }}</td>
                <td>{{ p.total_cost }}</td>
                <td>{{ p.confidence }}</td>
                <td>{{ p.time_to_value }}</td>
                <td>{{ p.roi }}</td>
                <td>
                    <a href="{{ url_for('main.edit_project', project_id=p.project_id) }}"
                       class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-pencil-square"></i>
                    </a>
                </td>
                <td>
                    <form action="{{ url_for('main.delete_project', project_id=p.project_id) }}" method="POST"
                          onsubmit="return confirm('Are you sure you want to delete this project?');">
                        <button class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

{% endif %}

</div>

<footer class="text-center mt-5 text-secondary">
    Â© 2025 VECTR. All rights reserved.
</footer>

<script>
{% if project_data|length > 0 %}

// --------- ZONEKLEUR FUNCTIE ---------
function getZoneColor(conf, ttv) {
    if (conf <= 7 && ttv <= 5) return "#ff0000";       // rood
    if (conf <= 7 && ttv > 5) return "#e67e22";        // oranje
    if (conf > 7 && ttv > 4 && ttv <= 7) return "#9acd32"; // lichtgroen
    if (conf > 7 && ttv > 7) return "#009933";         // donkergroen
    if (conf > 7 && ttv <= 4) return "#e67e22";        // oranje
    if (conf <= 1 && ttv > 7) return "#ff0000";       // rood
    return "#000000";
}

const ctx = document.getElementById('projectChart').getContext('2d');

// --------- DATA LADEN ---------
const currentPoints = [];
const oldPoints = [];
const arrows = [];

{% for p in project_data %}
    {% if p.confidence is not none and p.time_to_value is not none %}
        currentPoints.push({
            x: {{ p.confidence }},
            y: {{ p.time_to_value }},
            roi: {{ p.roi or 0 }}
        });
    {% endif %}

    {% if p.old_confidence is not none and p.old_time_to_value is not none %}
        oldPoints.push({
            x: {{ p.old_confidence }},
            y: {{ p.old_time_to_value }},
            roi: {{ p.old_roi or 0 }}
        });

        arrows.push({
            x1: {{ p.old_confidence }},
            y1: {{ p.old_time_to_value }},
            x2: {{ p.confidence }},
            y2: {{ p.time_to_value }}
        });
    {% endif %}
{% endfor %}

// --------- DATASETS (GEEN LABELS) ---------
let datasets = [];

// CURRENT
datasets.push({
    data: currentPoints,
    backgroundColor: ctx => getZoneColor(ctx.raw.x, ctx.raw.y),
    pointRadius: ctx => 6 + Math.min((ctx.raw.roi || 0) / 10, 12)
});

// OLD
if (oldPoints.length > 0) {
    datasets.push({
        data: oldPoints,
        backgroundColor: ctx => getZoneColor(ctx.raw.x, ctx.raw.y),
        pointRadius: ctx => 6 + Math.min((ctx.raw.roi || 0) / 10, 12)
    });
}

// --------- CHART CONFIG (LEGEND UIT) ---------
const chartConfig = {
    type: 'scatter',
    data: { datasets: datasets },
    options: {
        plugins: {
            legend: {
                display: false   // ðŸ‘ˆ VERWIJDERT JE undefined/defined legend
            }
        },
        scales: {
            x: {
                min: 0,
                max: 10,
                title: { display: true, text: 'Confidence Level', color: '#0d6efd' }
            },
            y: {
                min: 0,
                max: 10,
                title: { display: true, text: 'Time to Value', color: '#0d6efd' }
            }
        }
    }
};

// --------- ARROWS ---------
if (arrows.length > 0) {
    chartConfig.plugins = [{
        id: 'arrows',
        afterDraw: chart => {
            const cx = chart.ctx;

            arrows.forEach(a => {
                const x1 = chart.scales.x.getPixelForValue(a.x1);
                const y1 = chart.scales.y.getPixelForValue(a.y1);
                const x2 = chart.scales.x.getPixelForValue(a.x2);
                const y2 = chart.scales.y.getPixelForValue(a.y2);

                // ------- STIPPENLIJN -------
                cx.beginPath();
                cx.setLineDash([10, 4]);     // dashed
                cx.moveTo(x1, y1);  
                cx.lineTo(x2 , y2);
                cx.lineWidth = 1;
                cx.strokeStyle = "#000000";
                cx.stroke();
                cx.setLineDash([]);          // reset dashed

                // ------- PIJLPUNT -------
                const headLength = 12;       // lengte van de pijl
                const angle = Math.atan2(y2 - y1, x2 - x1);

                cx.beginPath();
                cx.moveTo(x2, y2);

                // Linkerpunt van de pijlkop
                cx.lineTo(
                    x2 - headLength * Math.cos(angle - Math.PI / 6),
                    y2 - headLength * Math.sin(angle - Math.PI / 6)
                );

                cx.moveTo(x2, y2);

                // Rechterpunt van de pijlkop
                cx.lineTo(
                    x2 - headLength * Math.cos(angle + Math.PI / 6),
                    y2 - headLength * Math.sin(angle + Math.PI / 6)
                );

                cx.strokeStyle = "#000000";
                cx.lineWidth = 1;
                cx.stroke();
            });
        }
    }];
}



new Chart(ctx, chartConfig);

{% endif %}
</script>

</body>
</html>
